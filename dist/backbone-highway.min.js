!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("underscore"),require("backbone"),require("url-composer")):"function"==typeof define&&define.amd?define(["underscore","backbone","url-composer"],t):(e.Backbone=e.Backbone||{},e.Backbone.Highway=t(e._,e.Backbone,e.urlComposer))}(this,function(e,t,n){"use strict";function r(t){this.definition=e.extend({},u,t),this.configure()}e="default"in e?e.default:e,t="default"in t?t.default:t,n="default"in n?n.default:n;var i=function(){function t(e){return c[e]}function n(e,t){c[e]=t}function r(t){var n=t.get("name");if(e.has(u,n))throw new Error("[ highway ] Route named "+n+" already declared");u[n]=t}function i(t){if(t.path){var n=this.get("options");t.path=t.path.replace(n.root,"").replace(/^(\/|#)/,"")}return e.find(u,function(e){return t.name===e.get("name")||e.pathRegExp&&e.pathRegExp.test(t.path)})}function a(){var t={},n={};return e.forEach(u,function(e,n){t[e.get("path")]=n}),e.forEach(u,function(e,t){n[t]=e.get("action")}),e.extend({routes:t},n)}function o(){return h}function s(e){h=e}var u={},c={},h=null;return{get:t,set:n,save:r,find:i,getDefinitions:a,getLastRoute:o,setLastRoute:s}}(),a={create:function(){return new(t.Router.extend(i.getDefinitions()))},start:function(n){return t.History.started?null:t.history.start(e.pick(n,["pushState","hashChange","silent","root"]))},restart:function(){t.history.stop(),t.history.start()}},o={dispatch:function(t,n){var r=i.get("options"),a=r.dispatcher;if(e.isString(t)&&(t={name:t}),!a)throw new Error("[ highway ] Event '"+t.name+"' could not be triggered, missing dispatcher");n=t.params||n,console.log("Trigger event "+t.name+", params:",n),a.trigger(t.name,{params:n})},exec:function(t){var n=this,r=t.name,i=t.events,a=t.params;if(!e.isEmpty&&!e.isArray(i))throw new Error("[ highway ] Route events definition for "+r+" needs to be an Array");return e.isArray(i)||(i=[i]),Promise.all(e.map(i,function(t){return e.isFunction(t)?new Promise(function(e,n){return t({resolve:e,reject:n,params:a}),null}):(n.dispatch(t,a),Promise.resolve())}))}},s=["404"],u={name:null,path:null,action:null},c={trigger:!0,replace:!1};r.prototype={get:function(e){return this.definition[e]},set:function(e,t){this.definition[e]=t},parse:function(e){return n.build({path:this.get("path"),params:e})},configure:function(){var t=this.definition,r=t.name,i=t.path;i&&!e.includes(s,r)&&(e.isString(i)&&(i=i.replace(/^(\/|#)/,"")),this.pathRegExp=n.regex(i),this.set("path",i)),this.set("action",this.getActionWrapper())},execute:function(){for(var e=[],t=arguments.length;t--;)e[t]=arguments[t];return this.get("action").apply(void 0,e)},getActionWrapper:function(){var e=this.definition,t=e.name,r=e.path,i=e.action,a=e.before,s=e.after;return function(){for(var e=[],u=arguments.length;u--;)e[u]=arguments[u];var c=n.params(r,e);return new Promise(function(e,n){return a?o.exec({name:t,events:a,params:c}).then(function(){return Promise.resolve(i({resolve:e,reject:n,params:c}))}).then(e,n):Promise.resolve(i({resolve:e,reject:n,params:c}))}).then(function(e){return!s||o.exec({name:t,events:s,params:c})}).catch(function(e){console.error("caught action error",e)})}},getNavigateOptions:function(t){return e.extend({},c,e.pick(t,["trigger","replace"]))}};var h={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!1,dispatcher:null},f=function(){var e=i.find({name:"404"});e&&e.execute()};return{start:function(t){t=e.extend({},h,t),i.set("options",t),this.router=a.create(),a.start(t)||t.silent||f()},route:function(e){var t=new r(e);i.save(t),this.router&&t.get("path")&&this.router.route(t.get("path"),t.get("name"),t.get("action"))},go:function(t){if(!e.isString(t)&&!e.isObject(t))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+t+'"');if(e.isObject(t)&&!t.name&&!t.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');e.isString(t)&&(t={name:t});var n=i.find(t);if(!n)return f(),!1;t.path||(t.path=n.parse(t.args||t.params)),this.router.navigate(t.path,n.getNavigateOptions(t));var r=i.getLastRoute();return t.force&&r&&n.get("name")===r.get("name")&&this.reload(),i.setLastRoute(n),!0},reload:a.restart,restart:a.restart,store:i}});