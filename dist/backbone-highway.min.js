!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("underscore"),require("qs"),require("backbone"),require("url-composer")):"function"==typeof define&&define.amd?define(["underscore","qs","backbone","url-composer"],e):(t.Backbone=t.Backbone||{},t.Backbone.Highway=e(t._,t.qs,t.Backbone,t.urlComposer))}(this,function(t,e,r,n){"use strict";function a(e){this.definition=t.extend({},h,e),this.configure()}function i(t){var e=t.routeName,r=t.routePath,n=t.routeParams,a=t.message;if(void 0===a&&(a="Redirect Error"),this.message=a,this.name="RedirectError",this.routeName=e,this.routePath=r,this.routeParams=n,Error.captureStackTrace)Error.captureStackTrace(this);else{var i=Error();this.stack=i.stack}}t="default"in t?t.default:t,e="default"in e?e.default:e,r="default"in r?r.default:r,n="default"in n?n.default:n;var o=function(){function e(t){return c[t]}function r(t,e){c[t]=e}function n(e){var r=e.get("name");if(t.has(u,r))throw new Error("[ highway ] Route named "+r+" already declared");u[r]=e}function a(e){if(e.path){var r=this.get("options");e.path=e.path.replace(r.root,"").replace(/^(\/|#)/,"")}return t.find(u,function(t){return e.name===t.get("name")||t.pathRegExp&&t.pathRegExp.test(e.path)})}function i(){var e={},r={};return t.forEach(u,function(t,r){e[t.get("path")]=r}),t.forEach(u,function(t,e){r[e]=t.get("action")}),t.extend({routes:e},r)}function o(){return h}function s(t){h=t}var u={},c={},h=null;return{get:e,set:r,save:n,find:a,getDefinitions:i,getLastRoute:o,setLastRoute:s}}(),s={create:function(t){return new(r.Router.extend(Object.assign({},o.getDefinitions(),{execute:t})))},start:function(e){return r.History.started?null:r.history.start(t.pick(e,["pushState","hashChange","silent","root"]))},restart:function(){r.history.stop(),r.history.start()},back:function(){r.history.history.back()}},u={dispatch:function(e,r){var n=o.get("options"),a=n.dispatcher;if(t.isString(e)&&(e={name:e}),!a)throw new Error("[ highway ] Event '"+e.name+"' could not be triggered, missing dispatcher");r=e.params||r,console.log("Trigger event "+e.name+", params:",r),a.trigger(e.name,{params:r})},exec:function(e){var r=this,n=e.name,a=e.events,i=e.params;if(!t.isEmpty&&!t.isArray(a))throw new Error("[ highway ] Route events definition for "+n+" needs to be an Array");return t.isArray(a)||(a=[a]),Promise.all(t.map(a,function(e){return t.isFunction(e)?Promise.resolve(e({params:i})):(r.dispatch(e,i),Promise.resolve())}))}},c=["404"],h={name:null,path:null,action:null},p={trigger:!0,replace:!1};a.prototype={get:function(t){return this.definition[t]},set:function(t,e){this.definition[t]=e},parse:function(t){return n.build({path:this.get("path"),params:t})},configure:function(){var e=this.definition,r=e.name,a=e.path;a&&!t.includes(c,r)&&(t.isString(a)&&(a=a.replace(/^(\/|#)/,"")),this.pathRegExp=n.regex(a),this.set("path",a)),this.set("action",this.getActionWrapper())},execute:function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];return this.get("action").apply(void 0,t)},getActionWrapper:function(){var t=this.definition,r=t.name,a=t.path,i=t.action,o=t.before,s=t.after;return function(){for(var t=[],c=arguments.length;c--;)t[c]=arguments[c];var h=t.pop(),p={};h&&(p=e.parse(h)),!p&&h&&t.push(h);var f,g=n.params(a,t);return f=o?u.exec({name:r,events:o,params:g,query:p}).then(function(){return i({params:g,query:p})}):Promise.resolve(i({params:g,query:p})),f.then(function(t){return!s||u.exec({name:r,events:s,params:g,query:p})})}},getNavigateOptions:function(e){return t.extend({},p,t.pick(e,["trigger","replace"]))}},i.prototype=Object.create(Error.prototype);var f={RedirectError:i},g={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!1,dispatcher:null},d=function(){var t=o.find({name:"404"});if(t)return t.execute()};return{DEBUG:!1,start:function(e){var r=this;e=t.extend({},g,e),o.set("options",e),this.router=s.create(function(t,e,n){var a;t&&(a=t.apply(r,e)),a&&"function"==typeof a.then&&a.catch(function(t){return"RedirectError"===t.name?void r.go({name:t.routeName,path:t.routePath,params:t.routeParams}):r.error(t)})}),s.start(e)||e.silent||d()},route:function(t){var e=new a(t);o.save(e),this.router&&e.get("path")&&this.router.route(e.get("path"),e.get("name"),e.get("action"))},go:function(r){if(!t.isString(r)&&!t.isObject(r))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+r+'"');if(t.isObject(r)&&!r.name&&!r.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');t.isString(r)&&(r={name:r});var n=o.find(r);if(!n)return d(),!1;r.path||(r.path=n.parse(r.args||r.params)),r.query&&(r.path=r.path+"?"+e.stringify(r.query)),this.router.navigate(r.path,n.getNavigateOptions(r));var a=o.getLastRoute();return r.force&&a&&n.get("name")===a.get("name")&&this.reload(),o.setLastRoute(n),!0},back:function(){s.back()},reload:s.restart,restart:s.restart,store:o,error:function(t){return this.DEBUG&&console.error("Route Error",t),d()},errors:f}});